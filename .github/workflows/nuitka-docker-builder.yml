name: nuitka docker builder

on:
  push:
    tags: [v*]
    branches: ["master", "main"]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional tag name (defaults to branch name)'
        required: false

permissions:
  contents: read

jobs:
  bin-builder:
    timeout-minutes: 10
    strategy:
      matrix:
        host: ['amd', 'arm',]
        type: ['glibc', 'musl']
    env:
      platforms: >-
        ${{ matrix.host == 'amd' && 'linux/386,linux/amd64' ||
            matrix.type == 'glibc' && 'linux/arm/v7,linux/arm64/v8' || 
            'linux/arm/v6,linux/arm/v7,linux/arm64/v8' }}
    environment:
      name: preview
      url: https://github.com/NewFuture/DDNS/pkgs/container/nuitka-builder/
    runs-on: ubuntu-${{ matrix.host == 'arm' && '24.04-arm' || 'latest' }}
    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/${{ matrix.type }}.Dockerfile
          platforms: ${{ env.platforms }}
          target: base-builder
          push: true
          tags: |
            ghcr.io/newfuture/nuitka-builder:${{ matrix.type }}-${{ matrix.host }}

  docker-builder:
    timeout-minutes: ${{ matrix.host == 'qemu' && 30 || 10 }}
    strategy:
      matrix:
        include:
          - host: amd
            platforms: 'linux/386,linux/amd64'
          - host: arm
            platforms: 'linux/arm/v6,linux/arm/v7,linux/arm64/v8'
          - host: qemu
            platforms: 'linux/ppc64le,linux/riscv64,linux/s390x'
    environment:
      name: preview
      url: https://github.com/NewFuture/DDNS/pkgs/container/nuitka-builder/
    runs-on: ubuntu-${{ matrix.host == 'arm' && '24.04-arm' || 'latest' }}
    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-qemu-action@v3
        if: matrix.host == 'qemu'
        with:
          platforms: ${{ matrix.platforms }}

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          platforms: ${{ matrix.platforms }}
          target: base-builder
          push: true
          tags: |
            ghcr.io/newfuture/nuitka-builder:${{ matrix.host }}

  merge-bin-builder:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: [bin-builder]
    strategy:
      matrix:
        type: ['glibc', 'musl']
    runs-on: ubuntu-latest
    timeout-minutes: 5
    environment:
      name: preview
      url: https://github.com/NewFuture/DDNS/pkgs/container/nuitka-builder/
    permissions:
      packages: write
    steps:
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3
      - name: Merge images
        run: |
          set -ex
          docker buildx imagetools create \
            --tag ghcr.io/newfuture/nuitka-builder:${{matrix.type}}-${{ github.event.inputs.tag || github.ref_name }} \
            ghcr.io/newfuture/nuitka-builder:${{matrix.type}}-amd \
            ghcr-io/newfuture/nuitka-builder:${{matrix.type}}-arm \
            ghcr-io/newfuture/nuitka-builder:${{matrix.type}}-qemu

  merge-docker-builder:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: [docker-builder]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    environment:
      name: preview
      url: https://github.com/NewFuture/DDNS/pkgs/container/nuitka-builder/
    permissions:
      packages: write
    steps:
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3
      - name: Merge images
        run: |
          set -ex
          docker buildx imagetools create \
            --tag ghcr.io/newfuture/nuitka-builder:${{ github.event.inputs.tag || github.ref_name }} \
            ghcr.io/newfuture/nuitka-builder:amd \
            ghcr-io/newfuture/nuitka-builder:arm \
            ghcr-io/newfuture/nuitka-builder:qemu